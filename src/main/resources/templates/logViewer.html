<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ® LogViewer - é©¬é‡Œå¥¥åƒç´ é£æ ¼</title>

    <!-- Bootstrap 5 CSS -->
    <link th:href="@{/static/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/static/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/static/bootstrap/5.3.2/css/bootstrap-icons.min.css}">

    <!-- CodeMirror 5 CSS -->
    <link th:href="@{/static/codemirror/5.65.18/lib/codemirror.css}" rel="stylesheet"/>
    <link th:href="@{/static/codemirror/5.65.18/addon/search/matchesonscrollbar.css}" rel="stylesheet"/>
    
    <style>
        /* é©¬é‡Œå¥¥åƒç´ é£æ ¼ä¸»é¢˜ */
        :root {
            --mario-red: #e52521;
            --mario-blue: #3c44aa;
            --mario-green: #4bad4b;
            --mario-yellow: #fbd000;
            --mario-brown: #964b00;
            --mario-skin: #fcb97d;
            --pixel-bg: #6b8cff;
            --pixel-border: #000000;
            --pixel-highlight: #ff0000;
            --pixel-text: #ffffff;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            margin: 0;
            position: relative;
        }

        /* èƒŒæ™¯è£…é¥°å…ƒç´  */
        .background-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .mario-block {
            position: absolute;
            width: 40px;
            height: 40px;
            background: var(--mario-red);
            border: 4px solid var(--pixel-border);
            z-index: 1;
        }

        .mario-block.question {
            background: var(--mario-yellow);
            color: var(--pixel-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
        }

        .coin {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--mario-yellow);
            border: 2px solid var(--pixel-border);
            border-radius: 50%;
            animation: coinFloat 3s ease-in-out infinite;
        }

        @keyframes coinFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .pipe {
            position: absolute;
            width: 60px;
            background: var(--mario-green);
            border: 4px solid var(--pixel-border);
        }

        .pipe-top {
            height: 30px;
            border-bottom: none;
            border-radius: 30px 30px 0 0;
        }

        .pipe-stem {
            height: 80px;
            border-top: none;
        }

        .cloud {
            position: absolute;
            background: white;
            border: 3px solid var(--pixel-border);
            border-radius: 50%;
        }

        .cloud:before, .cloud:after {
            content: "";
            position: absolute;
            background: white;
            border: 3px solid var(--pixel-border);
            border-radius: 50%;
        }

        /* å¯¼èˆªæ åƒç´ é£æ ¼ */
        .navbar-mario {
            background: linear-gradient(to right, var(--mario-red), #c0392b) !important;
            border: 4px solid var(--pixel-border);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            position: relative;
        }

        .navbar-mario::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                var(--mario-yellow),
                var(--mario-yellow) 15px,
                var(--mario-red) 15px,
                var(--mario-red) 30px
            );
        }

        .navbar-brand {
            font-weight: bold;
            text-shadow: 3px 3px 0px var(--pixel-border);
            letter-spacing: 2px;
            color: var(--pixel-text) !important;
        }

        /* å¡ç‰‡åƒç´ é£æ ¼ */
        .card-mario {
            background: var(--pixel-bg);
            border: 6px solid var(--pixel-border);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .card-mario::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: repeating-linear-gradient(
                90deg,
                var(--pixel-highlight),
                var(--pixel-highlight) 15px,
                var(--pixel-bg) 15px,
                var(--pixel-bg) 30px
            );
        }

        .card-header-mario {
            background: linear-gradient(to right, var(--mario-blue), #2980b9);
            color: var(--pixel-text);
            border: 4px solid var(--pixel-border);
            font-weight: bold;
            text-shadow: 2px 2px 0px var(--pixel-border);
            letter-spacing: 1px;
            position: relative;
        }

        /* è¡¨å•å…ƒç´ åƒç´ é£æ ¼ */
        .form-control-mario {
            background: white;
            border: 4px solid var(--pixel-border);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 10px;
        }

        .form-control-mario:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(60, 68, 170, 0.25);
            border-color: var(--mario-blue);
        }

        .btn-mario {
            background: linear-gradient(to bottom, var(--mario-green), #27ae60);
            color: var(--pixel-text);
            border: 4px solid var(--pixel-border);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
            transition: all 0.1s;
            text-shadow: 2px 2px 0px var(--pixel-border);
        }

        .btn-mario:hover {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom, #27ae60, #219653);
        }

        .btn-mario:active {
            transform: translate(6px, 6px);
            box-shadow: 0px 0px 0px rgba(0,0,0,0.3);
        }

        /* ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨ */
        .list-group-item-mario {
            background: white;
            border: 2px solid var(--pixel-border);
            margin-bottom: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-group-item-mario:hover {
            background: var(--mario-yellow);
            transform: translate(2px, 2px);
        }

        .list-group-item-mario.active {
            background: var(--mario-green);
            color: var(--pixel-text);
        }

        /* CodeMirror è‡ªå®šä¹‰æ ·å¼ */
        .CodeMirror {
            border: 4px solid var(--pixel-border) !important;
            font-family: 'Courier New', monospace !important;
        }

        .CodeMirror-gutters {
            background: var(--mario-yellow) !important;
            border-right: 2px solid var(--pixel-border) !important;
        }

        .CodeMirror-linenumber {
            color: var(--pixel-border) !important;
            font-weight: bold !important;
        }

        /* é«˜äº®æœç´¢ç»“æœ */
        .highlight {
            background-color: var(--mario-yellow) !important;
            color: var(--pixel-border) !important;
            font-weight: bold !important;
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        .footer-info {
            text-align: center;
            margin-top: 20px;
            color: var(--mario-brown);
            font-size: 0.9rem;
            text-shadow: 1px 1px 0px white;
        }

        .footer-info a {
            color: var(--mario-blue);
            text-decoration: none;
            font-weight: bold;
        }

        .footer-info a:hover {
            color: var(--mario-red);
            text-decoration: underline;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class="background-elements">
        <!-- äº‘æœµ -->
        <div class="cloud" style="top: 50px; left: 100px; width: 80px; height: 40px;"></div>
        <div class="cloud" style="top: 120px; right: 150px; width: 100px; height: 50px;"></div>
        
        <!-- ç®¡é“ -->
        <div class="pipe pipe-top" style="bottom: 50px; right: 100px; width: 60px;"></div>
        <div class="pipe pipe-stem" style="bottom: 50px; right: 100px; width: 60px;"></div>
        
        <!-- é‡‘å¸ -->
        <div class="coin" style="top: 80px; right: 300px;"></div>
        <div class="coin" style="top: 150px; left: 250px;"></div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark navbar-mario">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-scroll"></i> LOGVIEWER - æ—¥å¿—æŸ¥çœ‹å™¨
            </span>
            <div class="d-flex">
                <div class="form-check form-switch text-light me-3">
                    <i class="fas fa-heart" style="color: var(--mario-red);"></i>
                    Powered by Moshow | 
                    <a href="https://zhengkai.blog.csdn.net/" target="_blank">
                        <i class="fab fa-blogger"></i> CSDN
                    </a> | 
                    <a href="https://github.com/moshowgame/windows-remote-admin" target="_blank">
                        <i class="fab fa-github"></i> GitHub
                    </a>
                    <i class="fas fa-heart" style="color: var(--mario-red);"></i>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row mt-3">
            <!-- ä¾§è¾¹æ  -->
            <div class="col-md-3">
                <div class="card card-mario">
                    <div class="card-header card-header-mario">
                        <i class="fas fa-folder-open"></i> æ–‡ä»¶åˆ—è¡¨
                    </div>
                    <div class="card-body p-0">
                        <div class="card-header bg-white border-0">
                            <p id="fileName" class="mb-2 fw-bold"></p>
                        </div>
                        <ul class="list-group list-group-flush" id="fileListSidebar"></ul>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»ç¼–è¾‘å™¨åŒºåŸŸ -->
            <div class="col-md-9">
                <div class="card card-mario">
                    <div class="card-header card-header-mario">
                        <i class="fas fa-search"></i> æ—¥å¿—æœç´¢ä¸æŸ¥çœ‹
                    </div>
                    <div class="card-body p-3">
                        <!-- æœç´¢æ§ä»¶ -->
                        <div class="row mb-3 g-2">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">æ–‡ä»¶ååŒ¹é…</label>
                                <input type="text" id="fileNamePattern" class="form-control form-control-mario" placeholder="log">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">åŒ…å«å…³é”®è¯</label>
                                <input type="text" id="keyWord" class="form-control form-control-mario" placeholder="ERROR">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">æŸ¥è¯¢å¤©æ•°</label>
                                <input type="number" id="days" class="form-control form-control-mario" placeholder="1" min="1" max="999" value="1">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" id="searchBtn" class="btn btn-mario w-100">
                                    <i class="fas fa-search"></i> æœç´¢
                                </button>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" id="refreshBtn" class="btn btn-mario w-100">
                                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                                </button>
                            </div>
                        </div>
                        
                        <!-- å†…å®¹æœç´¢ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">å†…å®¹æœç´¢ (å®æ—¶é«˜äº®)</label>
                            <input type="text" id="searchInput" class="form-control form-control-mario" placeholder="è¾“å…¥å…³é”®è¯è¿›è¡Œé«˜äº®æœç´¢...">
                        </div>
                        
                        <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
                        <div class="border rounded" style="min-height: 500px;">
                            <textarea id="logEditor" name="logEditor"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="footer-info">
        <i class="fas fa-mario" style="color: var(--mario-red);"></i>
        Windows Remote Admin - ä¸“ä¸ºWindowsè¿œç¨‹ç®¡ç†è€Œç”Ÿ
        <i class="fas fa-mario" style="color: var(--mario-red);"></i>
    </div>

    <!-- è„šæœ¬ä¾èµ– -->
    <script th:src="@{/static/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/static/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>

    <!-- CodeMirror 5 JavaScript -->
    <script th:src="@{/static/codemirror/5.65.18/lib/codemirror.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/addon/mode/loadmode.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/mode/verilog/verilog.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/addon/search/search.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/addon/search/searchcursor.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/addon/scroll/annotatescrollbar.js}"></script>
    <script th:src="@{/static/codemirror/5.65.18/addon/search/matchesonscrollbar.js}"></script>

    <script th:inline="javascript">
        $(function() {
            const readUrl = /*[[ @{/read} ]]*/ '';
            const listPlusUrl = /*[[ @{/listPlus} ]]*/ '';
            const filePath = /*[[${filePath}]]*/ '';
            const fileNamePattern = /*[[${fileNamePattern}]]*/ '';
            const keyWord = /*[[${keyWord}]]*/ '';
            
            $('#fileName').html('<i class="fas fa-folder"></i> å½“å‰è·¯å¾„: ' + filePath);
            let originalContent = "";

            // åˆå§‹åŒ–CodeMirror 5ç¼–è¾‘å™¨
            const textarea = document.getElementById('logEditor');
            const editor = CodeMirror.fromTextArea(textarea, {
                lineNumbers: true,
                mode: 'text/plain',
                theme: 'default',
                readOnly: true,
                viewportMargin: Infinity,
                autoRefresh: true,
                lineWrapping: true
            });
            
            // è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
            editor.setSize('100%', '500px');
            
            // å®‰å…¨çš„setValueåŒ…è£…å‡½æ•°
            function safeSetValue(cm, value) {
                try {
                    const content = value || '';
                    cm.setValue(typeof content === 'string' ? content : String(content));
                    cm.refresh();
                } catch (e) {
                    console.error('Error setting editor value:', e);
                    cm.setValue('âš ï¸ å†…å®¹åŠ è½½å‡ºç°é”™è¯¯');
                    cm.refresh();
                }
            }
            
            // æ·»åŠ çª—å£resizeç›‘å¬
            window.addEventListener('resize', () => editor.refresh());

            // æœç´¢æ–‡æœ¬é«˜äº®åŠŸèƒ½
            $('#searchInput').on('input', function() {
                const query = $(this).val();
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                editor.operation(function() {
                    for (let i = 0; i < editor.lineCount(); i++) {
                        editor.removeLineClass(i, "wrap", "highlight-line");
                    }
                });
                
                if (query) {
                    const cursor = editor.getSearchCursor(query, CodeMirror.Pos(0, 0));
                    while (cursor.findNext()) {
                        editor.markText(cursor.from(), cursor.to(), { 
                            className: 'highlight' 
                        });
                    }
                }
            });

            // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#searchBtn').click(function() {
                const $btn = $(this);
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æœç´¢ä¸­...');
                
                $.ajax({
                    url: listPlusUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        filePath: filePath, 
                        fileNamePattern: $('#fileNamePattern').val(), 
                        keyWord: $('#keyWord').val(),
                        days: $('#days').val()
                    }),
                    success: function(response) {
                        renderFileListSidebar(response.data);
                        $btn.prop('disabled', false).html(originalText);
                    },
                    error: function(error) {
                        console.error('Error searching files:', error);
                        alert('æœç´¢å¤±è´¥: ' + (error.responseJSON?.msg || 'æœªçŸ¥é”™è¯¯'));
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // åˆ·æ–°æŒ‰é’®
            $('#refreshBtn').click(function() {
                location.reload();
            });

            // æ¸²æŸ“ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨
            function renderFileListSidebar(files) {
                const $fileListSidebar = $('#fileListSidebar').empty();
                files.forEach(file => {
                    const $listItem = $(`
                        <li class="list-group-item list-group-item-mario">
                            <i class="fas fa-file-alt"></i> ${file.name}
                            <span class="badge bg-secondary float-end">${file.size}</span>
                        </li>
                    `);
                    $listItem.click(function() {
                        $(this).addClass('active').siblings().removeClass('active');
                        $.ajax({
                            url: readUrl,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ filePath: filePath + "\\" + file.name }),
                            beforeSend: function() {
                                safeSetValue(editor, 'ğŸ® æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹...');
                            },
                            success: function(response) {
                                // ç¡®ä¿response.dataå­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²
                                originalContent = response || '';
                                if (typeof originalContent !== 'string') {
                                    originalContent = String(originalContent);
                                }
                                safeSetValue(editor, originalContent);
                                editor.scrollTo(0, 0); // æ»šåŠ¨åˆ°é¡¶éƒ¨
                                $('#searchInput').val('').trigger('input'); // æ¸…ç©ºæœç´¢
                            },
                            error: function(error) {
                                console.error('Error reading file:', error);
                                const errorMessage = "âŒ æ–‡ä»¶è¯»å–å¤±è´¥: " + (error.responseJSON?.msg || error.statusText || 'æœªçŸ¥é”™è¯¯');
                                safeSetValue(editor, errorMessage);
                            }
                        });
                    });
                    $fileListSidebar.append($listItem);
                });
            }

            // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æœç´¢
            $('#searchBtn').click();
        });
    </script>
</body>
</html>