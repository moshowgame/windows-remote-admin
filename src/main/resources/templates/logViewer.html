<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LogViewer</title>
    <!-- Vue 3 CDN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.4.0/vue.global.prod.min.js"></script>
    <!-- Naive UI CDN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/naive-ui/2.43.1/index.prod.js"></script>
    <style>
        #logEditor {
            min-height: calc(90vh - 180px);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 4px;
            overflow-x: auto;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .line-number {
            display: inline-block;
            width: 50px;
            color: #999;
            text-align: right;
            margin-right: 10px;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createApp, ref, computed, watch } = Vue;
        const {
            NConfigProvider, NCard, NLayout, NLayoutContent, NSpace,
            NInput, NInputGroup, NButton, NDataTable, NSpin, NAlert,
            NMessageProvider, createDiscreteApi
        } = naive;

        const readUrl = '/sre/read';
        const listPlusUrl = '/sre/listPlus';
        const filePath = /*[[${filePath}]]*/ '';
        const fileNamePattern = /*[[${fileNamePattern}]]*/ '';
        const keyWord = /*[[${keyWord}]]*/ '';

        const App = {
            setup() {
                const { message } = createDiscreteApi(['message']);
                const fileNamePatternInput = ref(fileNamePattern || '');
                const keyWordInput = ref(keyWord || '');
                const daysInput = ref(1);
                const searchKeyword = ref('');
                const fileContent = ref('');
                const fileList = ref([]);
                const loading = ref(false);
                const currentFilePath = ref(filePath);

                const columns = [
                    { title: '文件名', key: 'name', ellipsis: { tooltip: true } }
                ];

                const searchFiles = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(listPlusUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filePath: currentFilePath.value,
                                fileNamePattern: fileNamePatternInput.value,
                                keyWord: keyWordInput.value,
                                days: daysInput.value.toString()
                            })
                        });
                        const data = await res.json();
                        fileList.value = data.data;
                    } catch (error) {
                        message.error('搜索文件失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const selectFile = async (fileName) => {
                    loading.value = true;
                    try {
                        const fullPath = currentFilePath.value + '\\' + fileName;
                        const res = await fetch(readUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath: fullPath })
                        });
                        const data = await res.text();
                        fileContent.value = data;
                    } catch (error) {
                        message.error('读取文件失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const highlightedContent = computed(() => {
                    if (!searchKeyword.value || !fileContent.value) {
                        return fileContent.value;
                    }
                    const lines = fileContent.value.split('\n');
                    return lines.map(line => {
                        if (line.toLowerCase().includes(searchKeyword.value.toLowerCase())) {
                            return line.replace(
                                new RegExp(`(${searchKeyword.value})`, 'gi'),
                                '<span class="highlight">$1</span>'
                            );
                        }
                        return line;
                    }).join('\n');
                });

                const linesWithNumbers = computed(() => {
                    if (!highlightedContent.value) return [];
                    return highlightedContent.value.split('\n').map((line, index) => ({
                        number: index + 1,
                        content: line
                    }));
                });

                const scrollToLine = (lineNumber) => {
                    const element = document.getElementById(`line-${lineNumber}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };

                return {
                    currentFilePath,
                    fileNamePatternInput,
                    keyWordInput,
                    daysInput,
                    searchKeyword,
                    fileList,
                    columns,
                    loading,
                    linesWithNumbers,
                    searchFiles,
                    selectFile,
                    scrollToLine
                };
            },
            template: `
                <div style="background-color: #f5f5f5; min-height: 100vh; padding: 16px;">
                    <n-config-provider>
                        <n-card style="border-radius: 8px;">
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>LogViewer</span>
                                    <div style="font-size: 12px;">
                                        (c) Powered by Moshow (
                                        <a href="https://zhengkai.blog.csdn.net/" target="_blank">CSDN</a> |
                                        <a href="https://github.com/moshowgame/" target="_blank">GITHUB</a> )
                                    </div>
                                </div>
                            </template>
                            <n-layout has-sider style="height: 85vh;">
                                <n-layout-sider bordered width="300" style="background-color: #fff;">
                                    <div style="padding: 16px;">
                                        <h5 style="margin-bottom: 12px;">搜索设置</h5>
                                        <n-space vertical size="medium">
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 12px;">文件名模式</label>
                                                <n-input v-model:value="fileNamePatternInput" placeholder="匹配文件名" />
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 12px;">包含文本</label>
                                                <n-input v-model:value="keyWordInput" placeholder="关键字" />
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 12px;">查询范围(天数)</label>
                                                <n-input-number v-model:value="daysInput" :min="1" :max="999" style="width: 100%;" />
                                            </div>
                                            <n-button type="primary" block @click="searchFiles" :loading="loading">搜索</n-button>
                                        </n-space>
                                        <div style="margin-top: 16px; border-top: 1px solid #eee; padding-top: 12px;">
                                            <n-data-table
                                                :columns="columns"
                                                :data="fileList"
                                                :bordered="false"
                                                size="small"
                                                max-height="calc(85vh - 400px)"
                                                @row-click="(row) => selectFile(row.name)"
                                                style="cursor: pointer;"
                                            />
                                        </div>
                                    </div>
                                </n-layout-sider>
                                <n-layout-content style="background-color: #fff; padding: 16px;">
                                    <n-space vertical size="medium" style="margin-bottom: 16px;">
                                        <div>
                                            <label style="font-size: 12px; margin-right: 8px;">搜索日志内容(高亮显示)</label>
                                            <n-input v-model:value="searchKeyword" placeholder="输入关键词高亮显示" style="width: 300px;" />
                                        </div>
                                    </n-space>
                                    <n-spin :show="loading" style="min-height: 400px;">
                                        <div id="logEditor" v-if="linesWithNumbers.length > 0">
                                            <div v-for="line in linesWithNumbers" :key="line.number" :id="'line-' + line.number" style="display: flex;">
                                                <span class="line-number">{{ line.number }}</span>
                                                <span v-html="line.content"></span>
                                            </div>
                                        </div>
                                        <n-empty v-else description="请选择文件查看内容" />
                                    </n-spin>
                                </n-layout-content>
                            </n-layout>
                        </n-card>
                    </n-config-provider>
                </div>
            `
        };

        createApp(App).use(naive).mount('#app');
    </script>
</body>
</html>
