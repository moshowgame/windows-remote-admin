<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“„ TextViewer - é©¬é‡Œå¥¥åƒç´ é£æ ¼</title>

    <!-- Bootstrap 5 CSS -->
    <link th:href="@{/static/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/static/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/static/bootstrap/5.3.2/css/bootstrap-icons.min.css}">

    <style>
        /* é©¬é‡Œå¥¥åƒç´ é£æ ¼ä¸»é¢˜ */
        :root {
            --mario-red: #e52521;
            --mario-blue: #3c44aa;
            --mario-green: #4bad4b;
            --mario-yellow: #fbd000;
            --mario-brown: #964b00;
            --mario-skin: #fcb97d;
            --pixel-bg: #6b8cff;
            --pixel-border: #000000;
            --pixel-highlight: #ff0000;
            --pixel-text: #ffffff;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            margin: 0;
            position: relative;
        }

        /* èƒŒæ™¯è£…é¥°å…ƒç´  */
        .background-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .mario-block {
            position: absolute;
            width: 40px;
            height: 40px;
            background: var(--mario-red);
            border: 4px solid var(--pixel-border);
            z-index: 1;
        }

        .mario-block.question {
            background: var(--mario-yellow);
            color: var(--pixel-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
        }

        .coin {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--mario-yellow);
            border: 2px solid var(--pixel-border);
            border-radius: 50%;
            animation: coinFloat 3s ease-in-out infinite;
        }

        @keyframes coinFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .pipe {
            position: absolute;
            width: 60px;
            background: var(--mario-green);
            border: 4px solid var(--pixel-border);
        }

        .pipe-top {
            height: 30px;
            border-bottom: none;
            border-radius: 30px 30px 0 0;
        }

        .pipe-stem {
            height: 80px;
            border-top: none;
        }

        .cloud {
            position: absolute;
            background: white;
            border: 3px solid var(--pixel-border);
            border-radius: 50%;
        }

        .cloud:before, .cloud:after {
            content: "";
            position: absolute;
            background: white;
            border: 3px solid var(--pixel-border);
            border-radius: 50%;
        }

        /* å¯¼èˆªæ åƒç´ é£æ ¼ */
        .navbar-mario {
            background: linear-gradient(to right, var(--mario-red), #c0392b) !important;
            border: 4px solid var(--pixel-border);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            position: relative;
        }

        .navbar-mario::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                var(--mario-yellow),
                var(--mario-yellow) 15px,
                var(--mario-red) 15px,
                var(--mario-red) 30px
            );
        }

        .navbar-brand {
            font-weight: bold;
            text-shadow: 3px 3px 0px var(--pixel-border);
            letter-spacing: 2px;
            color: var(--pixel-text) !important;
        }

        /* å¡ç‰‡åƒç´ é£æ ¼ */
        .card-mario {
            background: var(--pixel-bg);
            border: 6px solid var(--pixel-border);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .card-mario::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: repeating-linear-gradient(
                90deg,
                var(--pixel-highlight),
                var(--pixel-highlight) 15px,
                var(--pixel-bg) 15px,
                var(--pixel-bg) 30px
            );
        }

        .card-header-mario {
            background: linear-gradient(to right, var(--mario-blue), #2980b9);
            color: var(--pixel-text);
            border: 4px solid var(--pixel-border);
            font-weight: bold;
            text-shadow: 2px 2px 0px var(--pixel-border);
            letter-spacing: 1px;
            position: relative;
        }

        /* è¡¨å•å…ƒç´ åƒç´ é£æ ¼ */
        .form-control-mario {
            background: white;
            border: 4px solid var(--pixel-border);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 10px;
        }

        .form-control-mario:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(60, 68, 170, 0.25);
            border-color: var(--mario-blue);
        }

        .btn-mario {
            background: linear-gradient(to bottom, var(--mario-green), #27ae60);
            color: var(--pixel-text);
            border: 4px solid var(--pixel-border);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
            transition: all 0.1s;
            text-shadow: 2px 2px 0px var(--pixel-border);
        }

        .btn-mario:hover {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom, #27ae60, #219653);
        }

        .btn-mario:active {
            transform: translate(6px, 6px);
            box-shadow: 0px 0px 0px rgba(0,0,0,0.3);
        }

        /* Ace Editor è‡ªå®šä¹‰æ ·å¼ */
        #logEditor {
            border: 4px solid var(--pixel-border) !important;
            border-radius: 0 !important;
        }

        /* æœç´¢é«˜äº®æ ·å¼ */
        .ace_highlight-marker {
            background-color: var(--mario-yellow) !important;
            color: var(--pixel-border) !important;
            font-weight: bold !important;
        }
        
        /* æœç´¢åŒ¹é…é¡¹é«˜äº® */
        .ace_marker-layer .ace_selected-word {
            background-color: rgba(251, 208, 0, 0.7) !important;
            border: 2px solid var(--mario-red) !important;
            border-radius: 2px;
        }
        
        .ace_marker-layer .ace_selection {
            background-color: rgba(251, 208, 0, 0.5) !important;
        }
        
        /* å½“å‰è¡Œé«˜äº® */
        .ace_marker-layer .ace_active-line {
            background-color: rgba(60, 68, 170, 0.1) !important;
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        .footer-info {
            text-align: center;
            margin-top: 20px;
            color: var(--mario-brown);
            font-size: 0.9rem;
            text-shadow: 1px 1px 0px white;
        }

        .footer-info a {
            color: var(--mario-blue);
            text-decoration: none;
            font-weight: bold;
        }

        .footer-info a:hover {
            color: var(--mario-red);
            text-decoration: underline;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            #logEditor {
                height: calc(100vh - 200px) !important;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class="background-elements">
        <!-- äº‘æœµ -->
        <div class="cloud" style="top: 50px; left: 100px; width: 80px; height: 40px;"></div>
        <div class="cloud" style="top: 120px; right: 150px; width: 100px; height: 50px;"></div>
        
        <!-- ç®¡é“ -->
        <div class="pipe pipe-top" style="bottom: 50px; right: 100px; width: 60px;"></div>
        <div class="pipe pipe-stem" style="bottom: 50px; right: 100px; width: 60px;"></div>
        
        <!-- é‡‘å¸ -->
        <div class="coin" style="top: 80px; right: 300px;"></div>
        <div class="coin" style="top: 150px; left: 250px;"></div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark navbar-mario">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-file-alt"></i> TEXTVIEWER - æ–‡æœ¬æŸ¥çœ‹å™¨
            </span>
            <div class="d-flex">
                <div class="form-check form-switch text-light me-3">
                    <i class="fas fa-heart" style="color: var(--mario-red);"></i>
                    Powered by Moshow | 
                    <a href="https://zhengkai.blog.csdn.net/" target="_blank">
                        <i class="fab fa-blogger"></i> CSDN
                    </a> | 
                    <a href="https://github.com/moshowgame/windows-remote-admin" target="_blank">
                        <i class="fab fa-github"></i> GitHub
                    </a>
                    <i class="fas fa-heart" style="color: var(--mario-red);"></i>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row mt-3">
            <!-- ä¸»ç¼–è¾‘å™¨åŒºåŸŸ -->
            <div class="col-12">
                <div class="card card-mario">
                    <div class="card-header card-header-mario">
                        <i class="fas fa-file"></i> æ–‡ä»¶å†…å®¹æŸ¥çœ‹
                        <button type="button" id="refreshBtn" class="btn btn-mario btn-sm float-end">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <!-- æ–‡ä»¶ä¿¡æ¯ -->
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>å½“å‰æ–‡ä»¶:</strong> <span id="fileName"></span>
                        </div>
                        
                        <!-- æœç´¢åŠŸèƒ½ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">å†…å®¹æœç´¢ (å®æ—¶é«˜äº®)</label>
                            <div class="input-group">
                                <input type="text" id="searchInput" class="form-control form-control-mario" placeholder="è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢å’Œé«˜äº®...">
                                <button class="btn btn-mario" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i> æ¸…é™¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
                        <div id="logEditor" style="height: calc(100vh - 300px); width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="footer-info">
        <i class="fas fa-mario" style="color: var(--mario-red);"></i>
        Windows Remote Admin - ä¸“ä¸ºWindowsè¿œç¨‹ç®¡ç†è€Œç”Ÿ
        <i class="fas fa-mario" style="color: var(--mario-red);"></i>
    </div>

    <!-- è„šæœ¬ä¾èµ– -->
    <script th:src="@{/static/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/static/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    
    <!-- Ace JS -->
    <script th:src="@{/static/ace/1.37.2/ace.min.js}"></script>
    <script th:src="@{/static/ace/1.37.2/ext-themelist.min.js}"></script>
    <script th:src="@{/static/ace/1.37.2/mode-logtalk.min.js}"></script>

    <script th:inline="javascript">
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        $(function() {
            const listUrl = /*[[ @{/list} ]]*/ '';
            const readUrl = /*[[ @{/read} ]]*/ '';
            const downloadUrl = /*[[ @{/download} ]]*/ '';
            const filePath = /*[[${filePath}]]*/ '';
            const parentPath = filePath.substring(0, filePath.lastIndexOf('\\'));
            const fileNameStr = filePath.substring(filePath.lastIndexOf('\\')+1,filePath.length);
            
            $('#fileName').html(`<i class="fas fa-folder"></i> ${filePath}`);
            
            let editor = ace.edit("logEditor");
            editor.setTheme("ace/theme/clouds"); // ä½¿ç”¨æ˜äº®ä¸»é¢˜é…åˆé©¬é‡Œå¥¥é£æ ¼
            editor.session.setMode("ace/mode/text"); // ä½¿ç”¨æ–‡æœ¬æ¨¡å¼
            editor.setReadOnly(true);
            editor.setOption("wrapBehavioursEnabled", true);
            editor.setOption("wrapMode", true);
            editor.setOption("scrollPastEnd", 0.1);
            editor.setShowPrintMargin(false); // éšè—æ‰“å°è¾¹è·çº¿
            
            // å¯ç”¨æœç´¢åŠŸèƒ½
            editor.setOption("highlightActiveLine", true);
            editor.setOption("highlightSelectedWord", true);
            // ä¸è¦æ‰‹åŠ¨è®¾ç½®$searchï¼Œè®©Ace Editorè‡ªå·±å¤„ç†
            
            // è®¾ç½®ç¼–è¾‘å™¨æ ·å¼
            document.getElementById('logEditor').style.border = '4px solid #000000';
            
            // å®‰å…¨çš„setValueåŒ…è£…å‡½æ•°
            function safeSetValue(cm, value) {
                try {
                    const content = value || '';
                    cm.setValue(typeof content === 'string' ? content : String(content));
                    cm.renderer.updateFull(true); // å¼ºåˆ¶åˆ·æ–°
                    cm.resize(true); // é‡æ–°è®¡ç®—å¤§å°
                } catch (e) {
                    console.error('Error setting editor value:', e);
                    cm.setValue('âš ï¸ å†…å®¹åŠ è½½å‡ºç°é”™è¯¯');
                    cm.renderer.updateFull(true);
                }
            }

            // è°ƒç”¨ /read æ¥å£è¯»å–æ–‡ä»¶å†…å®¹
            $.ajax({
                url: readUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ filePath: filePath }),
                beforeSend: function() {
                    safeSetValue(editor, 'ğŸ® æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹ï¼Œè¯·ç¨å€™...');
                },
                success: function(response) {
                    // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
                    let fileContent = '';
                    if (typeof response === 'string') {
                        // ç›´æ¥è¿”å›å­—ç¬¦ä¸²æ ¼å¼
                        fileContent = response;
                    } else if (response && response.data) {
                        // ResponseUtil.success()åŒ…è£…æ ¼å¼
                        fileContent = response.data;
                    } else {
                        fileContent = 'âš ï¸ æ— æ³•è§£ææ–‡ä»¶å†…å®¹';
                    }
                    
                    safeSetValue(editor, fileContent);
                    editor.scrollToLine(0);
                    editor.clearSelection();
                    
                    // å¦‚æœæ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œåº”ç”¨åŸºæœ¬çš„è¯­æ³•é«˜äº®
                    if (filePath.toLowerCase().endsWith('.log') || filePath.toLowerCase().endsWith('.txt')) {
                        applyLogHighlighting(fileContent);
                    }
                },
                error: function(error) {
                    console.error('Error reading file:', error);
                    const errorMessage = "âŒ æ–‡ä»¶è¯»å–å¤±è´¥: " + (error.responseJSON?.msg || error.statusText || 'æœªçŸ¥é”™è¯¯');
                    safeSetValue(editor, errorMessage);
                }
            });

            // æœç´¢åŠŸèƒ½
            $('#searchInput').on('input', function() {
                const query = $(this).val().trim();
                
                // æ¸…é™¤ä¹‹å‰çš„æœç´¢ç»“æœ
                try {
                    editor.findAll('', {
                        backwards: false,
                        wrap: true,
                        caseSensitive: false,
                        wholeWord: false,
                        regExp: false,
                        highlightAll: false
                    });
                } catch (e) {
                    // å¦‚æœfindAllå¤±è´¥ï¼Œä½¿ç”¨clearSelectionä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                    editor.clearSelection();
                }
                
                if (query) {
                    // æ‰§è¡Œæ–°çš„æœç´¢
                    try {
                        const options = {
                            backwards: false,
                            wrap: true,
                            caseSensitive: false,
                            wholeWord: false,
                            regExp: false,
                            highlightAll: true
                        };
                        
                        const found = editor.find(query, options);
                        
                        // å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œæ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…ä½ç½®
                        if (found) {
                            const cursor = editor.getCursorPosition();
                            editor.scrollToLine(cursor.row, true, true, function() {});
                        }
                    } catch (e) {
                        console.error('Search error:', e);
                    }
                }
            });

            // æ¸…é™¤æœç´¢
            $('#clearSearch').click(function() {
                $('#searchInput').val('');
                editor.clearSelection();
                try {
                    editor.findAll('', {
                        backwards: false,
                        wrap: true,
                        caseSensitive: false,
                        wholeWord: false,
                        regExp: false,
                        highlightAll: false
                    }); // æ¸…é™¤æ‰€æœ‰é«˜äº®
                } catch (e) {
                    // å¤‡é€‰æ–¹æ¡ˆ
                    editor.clearSelection();
                }
                editor.focus();
            });

            // åˆ·æ–°æŒ‰é’®
            $('#refreshBtn').click(function() {
                location.reload();
            });

            // ä¸ºæ—¥å¿—æ–‡ä»¶åº”ç”¨åŸºæœ¬é«˜äº®
            function applyLogHighlighting(content) {
                // ç®€å•çš„æ—¥å¿—çº§åˆ«é«˜äº®
                const lines = content.split('\n');
                const highlightedLines = lines.map(line => {
                    if (line.includes('ERROR') || line.includes('FATAL')) {
                        return `<span style="color: #e52521; font-weight: bold;">${line}</span>`;
                    } else if (line.includes('WARN') || line.includes('WARNING')) {
                        return `<span style="color: #fbd000; font-weight: bold;">${line}</span>`;
                    } else if (line.includes('INFO')) {
                        return `<span style="color: #3c44aa;">${line}</span>`;
                    } else if (line.includes('DEBUG')) {
                        return `<span style="color: #964b00;">${line}</span>`;
                    }
                    return line;
                });
                
                // æ³¨æ„ï¼šAce Editor ä¸ç›´æ¥æ”¯æŒ HTMLï¼Œè¿™é‡Œåªæ˜¯ç¤ºæ„
                // å®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨ Ace çš„æ ‡è®°åŠŸèƒ½æˆ–è€…è‡ªå®šä¹‰é«˜äº®è§„åˆ™
            }

            // é”®ç›˜å¿«æ·é”®
            $(document).keydown(function(e) {
                // Ctrl+F èšç„¦æœç´¢æ¡†
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    $('#searchInput').focus();
                    $('#searchInput').select();
                }
                // ESC æ¸…é™¤æœç´¢
                if (e.key === 'Escape') {
                    $('#clearSearch').click();
                }
                // Enteré”®åœ¨æœç´¢æ¡†ä¸­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹
                if (e.key === 'Enter' && document.activeElement.id === 'searchInput') {
                    e.preventDefault();
                    const query = $('#searchInput').val().trim();
                    if (query) {
                        editor.findNext();
                        const cursor = editor.getCursorPosition();
                        editor.scrollToLine(cursor.row, true, true, function() {});
                    }
                }
            });
            
            // æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„å¤„ç†
            $('#searchInput').focus(function() {
                $(this).select(); // è‡ªåŠ¨é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
            });
            
            // æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶æ¸…é™¤é€‰ä¸­
            $('#searchInput').blur(function() {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤±å»ç„¦ç‚¹æ—¶çš„å¤„ç†é€»è¾‘
            });
        });
    </script>
</body>
</html>