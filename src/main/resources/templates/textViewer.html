<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TextViewer</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.prod.js"></script>
    <!-- Naive UI CDN -->
    <script src="https://unpkg.com/naive-ui@2.38.0/dist/index.prod.js"></script>
    <style>
        #textEditor {
            min-height: calc(90vh - 150px);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 4px;
            overflow-x: auto;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .line-number {
            display: inline-block;
            width: 50px;
            color: #999;
            text-align: right;
            margin-right: 10px;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createApp, ref, computed, watch, onMounted } = Vue;
        const {
            NConfigProvider, NCard, NSpace, NInput, NSpin,
            NAlert, NEmpty, NMessageProvider, createDiscreteApi
        } = naive;

        const readUrl = '/sre/read';
        const filePath = /*[[${filePath}]]*/ '';

        const App = {
            setup() {
                const { message } = createDiscreteApi(['message']);
                const currentFilePath = ref(filePath);
                const searchKeyword = ref('');
                const fileContent = ref('');
                const loading = ref(false);
                const error = ref('');

                const highlightedContent = computed(() => {
                    if (!searchKeyword.value || !fileContent.value) {
                        return fileContent.value;
                    }
                    const lines = fileContent.value.split('\n');
                    return lines.map(line => {
                        if (line.toLowerCase().includes(searchKeyword.value.toLowerCase())) {
                            return line.replace(
                                new RegExp(`(${searchKeyword.value})`, 'gi'),
                                '<span class="highlight">$1</span>'
                            );
                        }
                        return line;
                    }).join('\n');
                });

                const linesWithNumbers = computed(() => {
                    if (!highlightedContent.value) return [];
                    return highlightedContent.value.split('\n').map((line, index) => ({
                        number: index + 1,
                        content: line
                    }));
                });

                const scrollToLine = (lineNumber) => {
                    const element = document.getElementById(`line-${lineNumber}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };

                const loadFile = async () => {
                    loading.value = true;
                    error.value = '';
                    try {
                        const res = await fetch(readUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath: currentFilePath.value })
                        });
                        if (res.ok) {
                            fileContent.value = await res.text();
                        } else {
                            const errData = await res.json();
                            error.value = `${errData.code || 'ERROR'} - ${errData.msg || errData.message || '读取文件失败'}`;
                        }
                    } catch (err) {
                        error.value = `读取文件失败: ${err.message}`;
                    } finally {
                        loading.value = false;
                    }
                };

                onMounted(() => {
                    loadFile();
                });

                return {
                    currentFilePath,
                    searchKeyword,
                    loading,
                    error,
                    linesWithNumbers,
                    scrollToLine
                };
            },
            template: `
                <div style="background-color: #f5f5f5; min-height: 100vh; padding: 16px;">
                    <n-config-provider>
                        <n-card style="border-radius: 8px;">
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>TextViewer</span>
                                    <div style="font-size: 12px;">
                                        (c) Powered by Moshow (
                                        <a href="https://zhengkai.blog.csdn.net/" target="_blank">CSDN</a> |
                                        <a href="https://github.com/moshowgame/" target="_blank">GITHUB</a> )
                                    </div>
                                </div>
                            </template>
                            <n-space vertical size="medium" style="margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <n-tag type="info">{{ currentFilePath }}</n-tag>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <label style="font-size: 12px;">搜索内容:</label>
                                        <n-input v-model:value="searchKeyword" placeholder="输入关键词高亮显示" style="width: 300px;" />
                                    </div>
                                </div>
                            </n-space>
                            <n-spin :show="loading" style="min-height: 400px;">
                                <n-alert v-if="error" type="error" :title="error" closable style="margin-bottom: 16px;" />
                                <div id="textEditor" v-if="linesWithNumbers.length > 0">
                                    <div v-for="line in linesWithNumbers" :key="line.number" :id="'line-' + line.number" style="display: flex;">
                                        <span class="line-number">{{ line.number }}</span>
                                        <span v-html="line.content"></span>
                                    </div>
                                </div>
                                <n-empty v-else-if="!loading && !error" description="文件内容为空" />
                            </n-spin>
                        </n-card>
                    </n-config-provider>
                </div>
            `
        };

        createApp(App).use(naive).mount('#app');
    </script>
</body>
</html>
