<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>File Explorer</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.prod.js"></script>
    <!-- Naive UI CDN -->
    <script src="https://unpkg.com/naive-ui@2.38.0/dist/index.prod.js"></script>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createApp, ref, onMounted, computed, watch } = Vue;
        const {
            NConfigProvider, NCard, NLayout, NLayoutSider, NLayoutContent,
            NMenu, NButton, NInput, NDataTable, NTag, NSpace, NIcon,
            NAlert, NModal, NSpin, NEmpty, NBreadcrumb, NBreadcrumbItem,
            NTooltip, NMessageProvider, createDiscreteApi, useMessage
        } = naive;

        const listUrl = '/sre/list';
        const logViewerUrl = '/sre/logViewer';
        const textViewerUrl = '/sre/textViewer';
        const readUrl = '/sre/read';
        const downloadUrl = '/sre/download';
        const normalizedPathUrl = '/sre/normalizedPath';

        const quickAccessPaths = [
            { label: 'C Drive', key: 'C:\\', icon: 'desktop' },
            { label: 'D Drive', key: 'D:\\', icon: 'desktop' },
            { label: 'E Drive', key: 'E:\\', icon: 'desktop' },
            { label: 'Qlik Sense Repository Log', key: 'C:\\ProgramData\\Qlik\\Sense\\Log\\Repository', icon: 'download' },
            { label: 'Qlik Sense Script Log', key: 'C:\\ProgramData\\Qlik\\Sense\\Log\\Script', icon: 'download' },
            { label: 'Qlik Sense ArchivedLogs', key: 'D:\\QlikShare\\ArchivedLogs', icon: 'download' },
            { label: 'DataShare', key: 'D:\\DataShare', icon: 'hard-drive' }
        ];

        const App = {
            setup() {
                const { message } = createDiscreteApi(['message']);
                const currentPath = ref('C:\\');
                const pathInput = ref('C:\\');
                const searchKeyword = ref('');
                const loading = ref(false);
                const fileData = ref([]);
                const history = ref([]);
                const historyIndex = ref(-1);
                const fileContent = ref('');
                const showContent = ref(false);
                const allFiles = ref([]);

                const columns = [
                    { title: 'ÂêçÁß∞', key: 'name', width: 300, ellipsis: { tooltip: true } },
                    { title: 'Á±ªÂûã', key: 'type', width: 100 },
                    { title: '‰øÆÊîπÊó•Êúü', key: 'lastModified', width: 180 },
                    { title: 'Â§ßÂ∞è', key: 'size', width: 120 },
                    { title: 'Êìç‰Ωú', key: 'actions', width: 250, fixed: 'right' }
                ];

                const formatFileSize = (bytes) => {
                    if (!bytes || bytes === '-') return '-';
                    const size = parseInt(bytes);
                    if (size >= 1024 * 1024 * 1024) {
                        return (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
                    } else if (size >= 1024 * 1024) {
                        return (size / (1024 * 1024)).toFixed(2) + ' MB';
                    } else if (size >= 1024) {
                        return (size / 1024).toFixed(2) + ' KB';
                    }
                    return size + ' B';
                };

                const loadPath = async (path, fromHistory = false) => {
                    if (!fromHistory) {
                        history.value = history.value.slice(0, historyIndex.value + 1);
                        history.value.push(path);
                        historyIndex.value++;
                    }

                    loading.value = true;
                    currentPath.value = path;

                    try {
                        // ÂÖàÊ†ºÂºèÂåñË∑ØÂæÑ
                        const normRes = await fetch(normalizedPathUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath: path })
                        });
                        const normData = await normRes.json();
                        const normalized = normData.data;
                        currentPath.value = normalized;
                        pathInput.value = normalized;

                        // Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
                        const res = await fetch(listUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath: normalized })
                        });
                        const data = await res.json();
                        allFiles.value = data.data.map(file => ({
                            ...file,
                            type: file.directory ? 'Êñá‰ª∂Â§π' : 'Êñá‰ª∂',
                            size: file.directory ? '-' : formatFileSize(file.size),
                            actions: file.directory ? [
                                { label: 'ËøõÂÖ•', type: 'primary', action: 'enter' },
                                { label: 'Êó•Âøó', type: 'info', action: 'log' }
                            ] : [
                                { label: 'ËØªÂèñ', type: 'success', action: 'read' },
                                { label: '‰∏ãËΩΩ', type: 'info', action: 'download' },
                                { label: 'Êü•Áúã', type: 'warning', action: 'view' }
                            ]
                        }));
                        fileData.value = allFiles.value;
                    } catch (error) {
                        message.error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleRowClick = (row) => {
                    if (row.directory) {
                        loadPath(currentPath.value + '\\' + row.name);
                    } else {
                        readFile(currentPath.value + '\\' + row.name);
                    }
                };

                const handleAction = (row, action) => {
                    const fullPath = currentPath.value + '\\' + row.name;
                    switch (action) {
                        case 'enter':
                            loadPath(fullPath);
                            break;
                        case 'read':
                            readFile(fullPath);
                            break;
                        case 'download':
                            downloadFile(fullPath);
                            break;
                        case 'view':
                            window.open(textViewerUrl + '?filePath=' + encodeURIComponent(fullPath), '_blank');
                            break;
                        case 'log':
                            window.open(logViewerUrl + '?filePath=' + encodeURIComponent(fullPath), '_blank');
                            break;
                    }
                };

                const readFile = async (filePath) => {
                    loading.value = true;
                    try {
                        const res = await fetch(readUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath })
                        });
                        const data = await res.text();
                        fileContent.value = data;
                        showContent.value = true;
                    } catch (error) {
                        message.error('ËØªÂèñÊñá‰ª∂Â§±Ë¥•');
                    } finally {
                        loading.value = false;
                    }
                };

                const downloadFile = async (filePath) => {
                    try {
                        const res = await fetch(downloadUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePath })
                        });
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filePath.split('\\').pop();
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        message.success('‰∏ãËΩΩÊàêÂäü');
                    } catch (error) {
                        message.error('‰∏ãËΩΩÂ§±Ë¥•');
                    }
                };

                const navigateHistory = (direction) => {
                    const newIndex = historyIndex.value + direction;
                    if (newIndex >= 0 && newIndex < history.value.length) {
                        historyIndex.value = newIndex;
                        loadPath(history.value[newIndex], true);
                    }
                };

                const goUp = () => {
                    const parts = currentPath.value.split('\\').filter(p => p);
                    if (parts.length > 1) {
                        loadPath(parts.slice(0, -1).join('\\') + '\\');
                    }
                };

                const handleSearch = () => {
                    const keyword = searchKeyword.value.toLowerCase();
                    if (keyword) {
                        fileData.value = allFiles.value.filter(file =>
                            file.name.toLowerCase().includes(keyword)
                        );
                    } else {
                        fileData.value = allFiles.value;
                    }
                };

                const handlePathEnter = () => {
                    const path = pathInput.value.trim();
                    if (path) {
                        loadPath(path);
                    }
                };

                const clearContent = () => {
                    showContent.value = false;
                    fileContent.value = '';
                };

                watch(searchKeyword, handleSearch);

                onMounted(() => {
                    loadPath(currentPath.value);
                });

                return {
                    currentPath,
                    pathInput,
                    searchKeyword,
                    loading,
                    fileData,
                    columns,
                    quickAccessPaths,
                    showContent,
                    fileContent,
                    loadPath,
                    handleRowClick,
                    handleAction,
                    navigateHistory,
                    goUp,
                    handlePathEnter,
                    clearContent
                };
            },
            template: `
                <div style="background-color: #f3f3f3; min-height: 100vh; padding: 16px;">
                    <n-config-provider>
                        <n-card style="border-radius: 8px; overflow: hidden;">
                            <n-layout has-sider style="height: 75vh;">
                                <n-layout-sider bordered width="250" style="background-color: rgba(255,255,255,0.9);">
                                    <div style="padding: 16px;">
                                        <h5 style="margin-bottom: 16px; color: #666;">Quick Access</h5>
                                        <n-space vertical size="small">
                                            <n-button
                                                v-for="path in quickAccessPaths"
                                                :key="path.key"
                                                text
                                                style="color: #333; justify-content: flex-start; padding: 8px 12px;"
                                                @click="loadPath(path.key)"
                                            >
                                                <template #icon>
                                                    <span style="margin-right: 8px;">üìÅ</span>
                                                </template>
                                                {{ path.label }}
                                            </n-button>
                                        </n-space>
                                    </div>
                                </n-layout-sider>
                                <n-layout-content>
                                    <div style="background-color: rgba(255,255,255,0.8); padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                        <n-space>
                                            <n-button-group>
                                                <n-button @click="navigateHistory(-1)" :disabled="loading">‚Üê</n-button>
                                                <n-button @click="navigateHistory(1)" :disabled="loading">‚Üí</n-button>
                                            </n-button-group>
                                            <n-button @click="goUp" :disabled="loading">‚Üë</n-button>
                                            <n-button @click="clearContent">üìÑ</n-button>
                                            <n-input
                                                v-model:value="pathInput"
                                                placeholder="ËæìÂÖ•Ë∑ØÂæÑ"
                                                style="width: 300px;"
                                                @keydown.enter="handlePathEnter"
                                                :disabled="loading"
                                            />
                                            <n-input
                                                v-model:value="searchKeyword"
                                                placeholder="ÊêúÁ¥¢Êñá‰ª∂"
                                                style="width: 200px;"
                                                :disabled="loading"
                                            />
                                        </n-space>
                                    </div>
                                    <div style="padding: 0;">
                                        <n-spin :show="loading" style="min-height: 300px;">
                                            <n-data-table
                                                :columns="columns"
                                                :data="fileData"
                                                :bordered="false"
                                                :single-line="false"
                                                size="small"
                                                @row-click="handleRowClick"
                                                style="cursor: pointer;"
                                            >
                                                <template #actions="{ row }">
                                                    <n-space>
                                                        <n-button
                                                            v-for="btn in row.actions"
                                                            :key="btn.action"
                                                            :type="btn.type"
                                                            size="tiny"
                                                            @click.stop="handleAction(row, btn.action)"
                                                        >
                                                            {{ btn.label }}
                                                        </n-button>
                                                    </n-space>
                                                </template>
                                            </n-data-table>
                                        </n-spin>
                                    </div>
                                    <div v-if="showContent" style="background-color: rgba(255,255,255,0.9); border-top: 1px solid #e0e0e0; padding: 16px; height: 300px; overflow-y: auto;">
                                        <n-alert type="success" title="Êñá‰ª∂ÂÜÖÂÆπ" closable @close="clearContent">
                                            <pre style="white-space: pre-wrap; word-break: break-all;">{{ fileContent }}</pre>
                                        </n-alert>
                                    </div>
                                    <div style="background-color: rgba(255,255,255,0.8); border-top: 1px solid #e0e0e0; padding: 8px 16px; font-size: 12px; display: flex; justify-content: space-between;">
                                        <span>{{ fileData.length }} ‰∏™È°πÁõÆ</span>
                                        <span>
                                            üìÅ EnterFolder | üìÑ LogViewer | üìÑ View Content | ‚¨áÔ∏è Download | üëÅÔ∏è TextViewer
                                            | <a href="https://github.com/moshowgame/SpringBootRemotePowershellAdmin" target="_blank">SRE</a>
                                            | <a href="https://zhengkai.blog.csdn.net/" target="_blank">by Moshow</a>
                                        </span>
                                    </div>
                                </n-layout-content>
                            </n-layout>
                        </n-card>
                    </n-config-provider>
                </div>
            `
        };

        createApp(App).use(naive).mount('#app');
    </script>
</body>
</html>
