<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PowerShell Online</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.prod.js"></script>
    <!-- Naive UI CDN -->
    <script src="https://unpkg.com/naive-ui@2.38.0/dist/index.prod.js"></script>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createApp, ref, nextTick, watch } = Vue;
        const { NConfigProvider, NCard, NLayout, NLayoutHeader, NLayoutContent, NSpace, NButton, NSelect, NTextarea, NScrollbar, NTag, NEmpty, NAlert, NSpin } = naive;

        const executeUrl = '/sre/execute';

        const quickCommands = [
            { label: '获取默认PS编码', value: '[Console]::OutputEncoding' },
            { label: '获取java进程', value: 'Get-Process | Where-Object { $_.ProcessName -like "*java*" }' },
            { label: '获取服务状态', value: 'Get-Service' },
            { label: '复制文件', value: 'Copy-Item -Path "C:\\temp\\file.txt" -Destination "D:\\backup\\"' },
            { label: '查询目录', value: 'Get-ChildItem -Path C:\\' },
            { label: '服务器重启事件', value: 'Get-EventLog -LogName System | Where-Object { $_.EventID -eq 6006 -or $_.EventID -eq 6005 } | Select-Object TimeGenerated, EventID, Message' },
            { label: '服务器登录事件', value: 'Get-WinEvent -LogName Security | Where-Object { $_.Id -eq 4624 -and $_.TimeCreated -gt (Get-Date).AddDays(-15) }' },
            { label: '获取IP地址', value: 'Get-NetIPAddress' },
            { label: 'RoboCopy', value: 'robocopy "C:\\SourceFolder" "D:\\DestinationFolder" "fileName" /XO /A-:D /S /MT:8' }
        ];

        const App = {
            setup() {
                const commandInput = ref('');
                const encoding = ref('UTF-8');
                const output = ref('');
                const loading = ref(false);
                const commandHistory = ref([]);
                const historyIndex = ref(-1);

                const encodingOptions = [
                    { label: 'UTF-8', value: 'UTF-8' },
                    { label: 'GB2312', value: 'GB2312' }
                ];

                const executeCommand = () => {
                    const cmd = commandInput.value.trim();
                    if (!cmd) return;

                    loading.value = true;
                    output.value += `\nPS > ${cmd}\n`;

                    fetch(executeUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: cmd, encoding: encoding.value })
                    })
                    .then(response => response.text())
                    .then(result => {
                        output.value += `${result}\n`;
                        // 保存到历史记录
                        commandHistory.value.push(cmd);
                        historyIndex.value = commandHistory.value.length;
                        localStorage.setItem('cmdHistory', JSON.stringify(commandHistory.value));
                    })
                    .catch(error => {
                        output.value += `错误: ${error}\n`;
                    })
                    .finally(() => {
                        loading.value = false;
                        commandInput.value = '';
                    });
                };

                const handleKeyDown = (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        executeCommand();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (historyIndex.value > 0) {
                            historyIndex.value--;
                            commandInput.value = commandHistory.value[historyIndex.value];
                        }
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (historyIndex.value < commandHistory.value.length - 1) {
                            historyIndex.value++;
                            commandInput.value = commandHistory.value[historyIndex.value];
                        } else {
                            historyIndex.value = commandHistory.value.length;
                            commandInput.value = '';
                        }
                    }
                };

                const selectQuickCommand = (cmd) => {
                    commandInput.value = cmd;
                };

                const clearOutput = () => {
                    output.value = '';
                };

                // 初始化历史记录
                const savedHistory = localStorage.getItem('cmdHistory');
                if (savedHistory) {
                    try {
                        commandHistory.value = JSON.parse(savedHistory);
                        historyIndex.value = commandHistory.value.length;
                    } catch (e) {}
                }

                output.value = `****** SpringBootRemotePowershellAdmin - execute your powershell script remotely ******
(c) Powered by Moshow ( CSDN | GITHUB ).

安装最新的 PowerShell，了解新功能和改进！https://aka.ms/PSWindows

`;

                return {
                    commandInput,
                    encoding,
                    encodingOptions,
                    output,
                    loading,
                    quickCommands,
                    executeCommand,
                    handleKeyDown,
                    selectQuickCommand,
                    clearOutput
                };
            },
            template: `
                <div style="background-color: #1a1a1a; min-height: 100vh; padding: 20px;">
                    <n-config-provider>
                        <n-card title="Remote PowerShell Admin" style="border-radius: 8px; background-color: #012456;">
                            <template #header-extra>
                                <a href="https://zhengkai.blog.csdn.net/" target="_blank" style="color: #fff;">CSDN</a>
                                <span style="color: #fff; margin: 0 10px;">|</span>
                                <a href="https://github.com/moshowgame/" target="_blank" style="color: #fff;">GITHUB</a>
                            </template>
                            <n-layout has-sider style="height: 70vh;">
                                <n-layout-sider bordered width="280" style="background-color: #0a0a0a;">
                                    <div style="padding: 16px;">
                                        <h4 style="color: #fff; margin-bottom: 16px;">常用命令</h4>
                                        <n-space vertical size="small">
                                            <n-button
                                                v-for="cmd in quickCommands"
                                                :key="cmd.value"
                                                text
                                                style="color: #00d2ff; justify-content: flex-start; padding: 8px 12px;"
                                                @click="selectQuickCommand(cmd.value)"
                                            >
                                                {{ cmd.label }}
                                            </n-button>
                                            <n-button text style="color: #00d2ff; justify-content: flex-start; padding: 8px 12px;" href="https://learn.microsoft.com/zh-tw/windows-server/administration/windows-commands/powershell" target="_blank">
                                                查询PS命令
                                            </n-button>
                                        </n-space>
                                    </div>
                                </n-layout-sider>
                                <n-layout-content style="background-color: #012456;">
                                    <div style="height: calc(100% - 120px); overflow-y: auto; padding: 16px; color: #34e134; font-family: 'Consolas', monospace; white-space: pre-wrap;" id="terminal">
                                        {{ output }}
                                    </div>
                                    <div style="padding: 16px; border-top: 1px solid #0078d4; background-color: #012456;">
                                        <n-space>
                                            <span style="color: #34e134; padding: 8px 0;">PS ></span>
                                            <n-input
                                                v-model:value="commandInput"
                                                type="textarea"
                                                :autosize="{ minRows: 1, maxRows: 4 }"
                                                placeholder="输入命令后按 Ctrl+Enter 执行"
                                                style="flex: 1;"
                                                @keydown="handleKeyDown"
                                                :disabled="loading"
                                            />
                                            <n-button type="primary" :loading="loading" @click="executeCommand">Execute</n-button>
                                            <n-button @click="clearOutput">Clean</n-button>
                                            <n-select
                                                v-model:value="encoding"
                                                :options="encodingOptions"
                                                style="width: 100px;"
                                            />
                                        </n-space>
                                    </div>
                                </n-layout-content>
                            </n-layout>
                        </n-card>
                    </n-config-provider>
                </div>
            `
        };

        createApp(App).use(naive).mount('#app');
    </script>
</body>
</html>
